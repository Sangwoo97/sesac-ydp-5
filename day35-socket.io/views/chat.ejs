<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>socket.io ì±„íŒ…</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="views/chat.css" />
  </head>
  <body>
    <h1>ğŸ–ì¦ê±°ìš´ ì±„íŒ…ğŸ–</h1>
    <div class="nickContainer">
      <input
        type="text"
        id="nickname"
        placeholder="ë‹‰ë„¤ì„"
        autofocus
        onkeypress="if(window.event.keyCode==13){join()}"
      />
      <button class="button-49" id="nicknameBtn" type="button" onclick="join();">ì…ì¥</button>
    </div>

    <main>
      <div class="chat-list"></div>
      <div class="chat-box" style="position: relative">
        <!-- ë©”ì„¸ì§€ ì „ì†¡ ì˜ì—­ -->
        <select id="nick-list"></select
        >ì—ê²Œ
        <input type="text" id="message" onkeypress="if(window.event.keyCode==13){send()}" />
        <button type="button" class="button-49" onclick="send();">ì „ì†¡</button>
      </div>
    </main>

    <script>
      let socket = io.connect(); // ì†Œì¼“ ì‚¬ìš©ì„ ìœ„í•œ ê°ì²´ ìƒì„±
      let nickname;

      socket.on('connect', () => {
        console.log('í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì™„ë£Œ : ', socket);
      });

      socket.on('sameNick', (data) => {
        alert(data);
      });

      socket.on('entrySuccess', (data) => {
        nickname = document.querySelector('#nickname').value;
        document.querySelector('#nickname').disabled = true;
        document.querySelector('#nicknameBtn').disabled = true;
        document.querySelector('.chat-box').style.display = 'flex';
        document.querySelector('.chat-list').classList.add('act');
      });

      socket.on('notice', (data) => {
        const list = document.querySelector('.chat-list');
        list.insertAdjacentHTML(
          'beforeend',
          `<div style="margin-bottom: 15px">${data.replaceAll('undefined', 'ì•Œìˆ˜ì—†ìŒ')}</div>`
        );
        scrollUl();
      });

      socket.on('updateNicks', (users) => {
        let options = `<option value="all">ì „ì²´</option>`;
        for (let user of Object.keys(users)) {
          if (users[user] !== nickname) {
            options += `<option value="${user}">${users[user]}</option>`;
          }
        }
        document.querySelector('#nick-list').innerHTML = options;
      });

      socket.on('newMessage', (data) => {
        const list = document.querySelector('.chat-list');
        if (data.nick === nickname) {
          list.insertAdjacentHTML(
            'beforeend',
            `<div class="my-chat">
                    <div class="my-chat-content">${data.nick} : ${data.content}</div>
                  </div>`
          );
        } else {
          list.insertAdjacentHTML(
            'beforeend',
            `<div class="other-chat">
                      <div class="other-chat-content">${data.nick} : ${data.content}</div>
                  </div>`
          );
        }
        document.querySelector('#message').value = '';
        scrollUl();
      });

      socket.on('newDirectMessage', (data) => {
        const list = document.querySelector('.chat-list');
        if (data.nick === nickname) {
          list.insertAdjacentHTML(
            'beforeend',
            `<div class="my-chat" >
                <div class="my-chat-content" style="background-color: orange">(ì†ë‹¥ì†ë‹¥) ${data.nick} : ${data.content}</div>
              </div>`
          );
        } else {
          list.insertAdjacentHTML(
            'beforeend',
            `<div class="other-chat" >
                <div class="other-chat-content" style="background-color: orange">(ì†ë‹¥ì†ë‹¥) ${data.nick} : ${data.content}</div>
              </div>`
          );
        }
        document.querySelector('#message').value = '';
        scrollUl();
      });

      const join = () => {
        if (document.querySelector('#nickname').value.length > 0) {
          socket.emit('setNick', document.querySelector('#nickname').value);
        } else {
          alert('í•œ ê¸€ìì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”');
        }
      };

      const send = () => {
        const content = document.querySelector('#message').value;
        const dropbox = document.querySelector('#nick-list');
        const dValue = dropbox.options[dropbox.selectedIndex].value;
        if (content.length > 0) {
          if (dValue === 'all') {
            socket.emit('send', { nick: nickname, content });
          } else {
            socket.emit('directSend', { id: dValue, nick: nickname, content });
          }
        } else {
          alert('ì±„íŒ…ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        }
      };

      function scrollUl() {
        // ì±„íŒ…ì°½ form ì•ˆì˜ ul ìš”ì†Œ, (ul ìš”ì†Œ ì•ˆì— ì±„íŒ… ë‚´ìš©ë“¤ì´ li ìš”ì†Œë¡œ ì…ë ¥ëœë‹¤.)
        let chatUl = document.querySelector('.chat-list');
        chatUl.scrollTop = chatUl.scrollHeight; // ìŠ¤í¬ë¡¤ì˜ ìœ„ì¹˜ë¥¼ ìµœí•˜ë‹¨ìœ¼ë¡œ
      }
    </script>
  </body>
</html>
